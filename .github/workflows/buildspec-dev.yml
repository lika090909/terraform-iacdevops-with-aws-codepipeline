name: Terraform CI

on:
  push:
    branches:
      - main

jobs:
  terraform:
    runs-on: ubuntu-latest

    env:
      TERRAFORM_VERSION: "0.15.3"
      TF_COMMAND: "apply"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Terraform
        run: |
          wget https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
          unzip terraform_${TERRAFORM_VERSION}_linux_amd64.zip
          sudo mv terraform /usr/local/bin/

      - name: Terraform Init & Apply
        run: |
          cd terraform-manifests
          terraform init -input=false --backend-config=dev.conf
          terraform validate
          terraform plan -lock=false -input=false -var-file=dev.tfvars
          terraform $TF_COMMAND -input=false -var-file=dev.tfvars -auto-approve
